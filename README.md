```markdown
# Django-CI-CD-NexusRegistry Guide

این مستندات شامل مراحل نصب، پیکربندی، و استفاده از اسکریپت `hardening.sh` برای امنیت و کانفیگ CI/CD در پروژه Django است. همچنین شامل تغییرات در پیکربندی SSH و Docker می‌باشد. در این مستندات همچنین نحوه دور زدن تحریم‌ها برای پرداخت هزینه به **Nginx** آورده شده است.

---

## 1. مراحل دریافت Public SSH Key

### 1.1 ایجاد کلید SSH  
برای دریافت Public Key سرور، ابتدا SSH Key جدید ایجاد می‌کنیم. دستور زیر را وارد کنید:

```bash
ssh-keygen -t rsa -b 4096 -C "abolfazlking22@gmail.com"
```

### 1.2 مشاهده کلید‌ها

پس از اجرای دستور بالا، کلید SSH شما در مسیر `/root/.ssh/` ذخیره می‌شود. برای مشاهده فایل‌ها و کلید خود، از دستور زیر استفاده کنید:

```bash
sudo ls -l /root/.ssh/
```

### 1.3 مشاهده Public Key

برای مشاهده Public Key، دستور زیر را وارد کنید:

```bash
sudo cat /root/.ssh/id_rsa.pub
```

کلید SSH که به دست آوردید باید در تنظیمات GitHub خود وارد کنید.

---

## 2. اضافه کردن SSH Key به GitHub

1. به حساب GitHub خود وارد شوید.
2. به بخش **Settings** بروید و **SSH and GPG Keys** را انتخاب کنید.
3. روی **New SSH Key** کلیک کنید و Public Key که در مرحله قبلی دریافت کرده‌اید را وارد کنید.

---

## 3. کلون کردن ریپازیتوری از GitHub

پس از اضافه کردن کلید SSH به GitHub، می‌توانید پروژه را از گیت‌هاب کلون کنید:

```bash
git clone git@github.com:AbolfazlMohammady/Django-CI-CD-NexsusRegestry.git
```

---

## 4. اسکریپت `hardening.sh`

برای دریافت تغییرات از گیت و اعمال آن‌ها در سرور، یک اسکریپت بنام `hardening.sh` ایجاد می‌کنیم. اسکریپت شامل دستوراتی برای انجام بروزرسانی‌های امنیتی و پیکربندی است.

---

### 4.1 گرفتن آخرین تغییرات از گیت

در داخل دایرکتوری پروژه، اسکریپت را اجرا می‌کنیم تا آخرین تغییرات را از گیت دریافت کنیم:

```bash
git pull origin
git pull origin main
```

### 4.2 دادن اجازه به اسکریپت برای اجرا

قبل از اجرای اسکریپت، باید به آن اجازه اجرا بدهیم:

```bash
chmod +x hardening.sh
```

### 4.3 اجرای اسکریپت

برای اجرای اسکریپت به صورت پس‌زمینه، از دستور زیر استفاده کنید:

```bash
nohup ./hardening.sh &
```

### 4.4 نمایش زنده لاگ‌ها

برای مشاهده لاگ‌های زنده اسکریپت، از دستور زیر استفاده کنید:

```bash
tail -f nohup.out
```

### 4.5 بررسی خروجی اسکریپت

برای بررسی نتایج و خروجی اسکریپت، فایل `nohup.out` را می‌توانید بررسی کنید:

```bash
cat nohup.out
```

### 4.6 بررسی پکیج در حال اجرا

اگر در هنگام اجرای اسکریپت با خطا مواجه شدید، ممکن است که پروسه‌ای در حال اجرای دستور `apt upgrade` باشد. برای بررسی این موضوع، از دستور زیر استفاده کنید:

```bash
ps aux | grep apt
```

### 4.7 توقف پروسه در حال اجرا

اگر یک پروسه با شناسه خاص در حال اجرای دستور `apt upgrade` است، باید آن را متوقف کنید. دستور زیر برای این کار استفاده می‌شود:

```bash
sudo kill -9 4444
```

---

## 5. نصب و تست Docker

برای نصب Docker و Docker Compose، از دستورات زیر استفاده کنید:

```bash
docker-compose --version
docker --version
```

---

## 6. تست تغییر پورت SSH

برای تغییر پورت SSH به پورت دلخواه (مثلاً 2226)، ابتدا باید پورت را تست کنید تا مطمئن شوید در حال استفاده است:

```bash
sudo ss -tuln | grep 2226
```

---

## 7. تغییر پورت SSH

بعد از تغییر پورت در فایل پیکربندی SSH (`/etc/ssh/sshd_config`)، برای اعمال تغییرات باید سرویس SSH را دوباره راه‌اندازی کنید:

```bash
sudo systemctl restart ssh
```

---

## 8. راه‌حل دور زدن تحریم‌ها برای پرداخت هزینه به Nginx

برای استفاده از خدمات خارجی مانند **Nginx** و دور زدن تحریم‌ها، شما می‌توانید از VPN یا سرویس‌های پروکسی استفاده کنید. در اینجا یک راهکار ساده برای اتصال به اینترنت بدون تحریم‌ها آورده شده است:

### 8.1 نصب و پیکربندی **VPN**

1. از یکی از سرویس‌دهندگان VPN معتبر استفاده کنید.
2. پروتکل OpenVPN را نصب و پیکربندی کنید.
3. اتصال به VPN را برای تغییر IP و دسترسی به Nginx از خارج کشور فعال کنید.

### 8.2 استفاده از **Proxies**

1. یک سرویس پروکسی پیدا کنید که به شما اجازه دهد به Nginx و سایر سرویس‌ها از خارج از کشور دسترسی پیدا کنید.
2. تنظیمات پروکسی را در فایل‌های پیکربندی Nginx اعمال کنید.

---

## 9. استفاده از **Clash Meta** برای دور زدن تحریم‌ها در Docker

### ✅ بهترین روش برای VPS داخل ایران: استفاده از **Clash Meta** به‌صورت سرور کلاینت

اگر از داخل ایران استفاده می‌کنید و نیاز دارید تا برای Docker یا سایر خدمات خارجی از اینترنت بدون تحریم استفاده کنید، نصب و راه‌اندازی **Clash Meta** یکی از بهترین گزینه‌هاست. در ادامه مراحل نصب و پیکربندی Clash Meta برای دور زدن تحریم‌ها و استفاده از Docker آورده شده است.

---

### 🎯 مراحل راه‌اندازی Clash Meta روی VPS (ساده و کاربردی):

#### 1. نصب Clash.Meta

   برای نصب Clash Meta، دستور زیر را وارد کنید:

```bash
   bash <(curl -Ls https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/main/install.sh)
```

   این دستور به صورت خودکار آخرین نسخه Clash Meta را دانلود و نصب می‌کند.

1. **وارد کردن فایل کانفیگ** :

   اگر اشتراک دارید (مثلاً `https://example.com/sub.yaml`)، باید فایل کانفیگ را وارد کنید. برای این کار، از دستور زیر استفاده کنید:

```bash
   nano ~/clash/config.yaml
```

   یا اگر فایل کانفیگ شما در مسیر `/root/.config/clash/meta.yaml` قرار دارد، آن را ویرایش کرده و فایل اشتراکتان را وارد کنید.

1. **اجرای Clash Meta** :

   برای اجرای Clash Meta، دستور زیر را وارد کنید:

```bash
   clash-meta -d ~/clash/
```

   یا اگر Clash Meta با **Systemd** راه‌اندازی شده باشد، از دستور زیر استفاده کنید:

```bash
   systemctl start clash
```

1. **تنظیم پروکسی برای Docker** :

   اگر Clash Meta روی پورت `7890` اجرا شده باشد، حالا باید پروکسی را برای Docker تنظیم کنید:

```bash
   sudo mkdir -p /etc/systemd/system/docker.service.d
   sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
```

   درون فایل بنویسید:

```ini
   [Service]
   Environment="HTTP_PROXY=http://127.0.0.1:7890"
   Environment="HTTPS_PROXY=http://127.0.0.1:7890"
   Environment="NO_PROXY=localhost,127.0.0.1"
```

   سپس، دستورهای زیر را اجرا کنید تا تغییرات اعمال شوند:

```bash
   sudo systemctl daemon-reexec
   sudo systemctl daemon-reload
   sudo systemctl restart docker
```

1. **تست** :

   برای تست پروکسی و اطمینان از درستی تنظیمات، دستور زیر را اجرا کنید:

```bash
   docker pull nginx
```

اگر این مراحل را به درستی انجام دهید، می‌توانید به راحتی از اینترنت بدون تحریم‌ها استفاده کنید و به خدمات خارجی مثل Nginx در Docker دسترسی پیدا کنید

برای نصب Clash Meta، دستور زیر را اجرا کنید:

```bash
bash <(curl -Ls https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/main/install.sh)
```

اگر این دستور کار نکرد، می‌توانیم به روش دستی آن را نصب کنیم.

---

#### 2. وارد کردن فایل کانفیگ:

اگر از **Clash** استفاده می‌کنید و اشتراک دارید (مثلاً `https://example.com/sub.yaml`)، می‌توانید فایل کانفیگ را وارد کنید. برای این کار:

```bash
nano ~/clash/config.yaml
```

یا اگر مسیر `/root/.config/clash/meta.yaml` است، آن را ویرایش کرده و فایل اشتراکتان را وارد کنید.
